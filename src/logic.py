# src/logic.py

import networkx as nx

def process_text_message(text: str, graph: nx.Graph = None) -> str:
    """
    –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç –±–æ—Ç–∞.
    –ú–æ–∂–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π –∏–ª–∏ –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞.
    """
    text_lower = text.lower().strip()

    # –ë–∞–∑–æ–≤—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è –∏ –ø—Ä–æ—â–∞–Ω–∏—è
    if text_lower in ["–ø—Ä–∏–≤–µ—Ç", "–∑–¥—Ä–∞–≤—Å—Ç–≤—É–π", "—Ö–∞–π", "–¥–æ–±—Ä—ã–π –¥–µ–Ω—å", "–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ"]:
        return "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫ —Ä–∞—Å—Ö–æ–¥–æ–≤. –ú–æ–≥—É —Ä–∞—Å—Å–∫–∞–∑–∞—Ç—å –ø—Ä–æ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –º–∞–≥–∞–∑–∏–Ω–∞–º–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏. –ß—Ç–æ —Ö–æ—á–µ—à—å —É–∑–Ω–∞—Ç—å?"

    if "–ø–æ–∫–∞" in text_lower or "–¥–æ —Å–≤–∏–¥–∞–Ω–∏—è" in text_lower or "–≤—ã—Ö–æ–¥" in text_lower:
        return "–î–æ –≤—Å—Ç—Ä–µ—á–∏! –í–æ–∑–≤—Ä–∞—â–∞–π—Å—è, –∫–æ–≥–¥–∞ –∑–∞—Ö–æ—á–µ—à—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è —Å —Ç—Ä–∞—Ç–∞–º–∏ üòä"

    # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –≥—Ä–∞—Ñ ‚Äî –∏—â–µ–º –≤ –Ω—ë–º
    if graph is not None:
        # –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —É–∑–ª–∞
        if text in graph.nodes:
            neighbors = list(graph.neighbors(text))
            if neighbors:
                return f"–ù–∞—à—ë–ª **{text}** –≤ –≥—Ä–∞—Ñ–µ –∑–Ω–∞–Ω–∏–π!\n–°–≤—è–∑–∞–Ω–æ —Å: **{', '.join(neighbors)}**"
            else:
                return f"–£–∑–µ–ª **{text}** –Ω–∞–π–¥–µ–Ω, –Ω–æ —Å–≤—è–∑–µ–π –ø–æ–∫–∞ –Ω–µ—Ç."

        # –ß–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (–µ—Å–ª–∏ –≤–≤–µ–ª–∏ –Ω–µ —Ç–æ—á–Ω–æ)
        matches = [node for node in graph.nodes if text_lower in node.lower()]
        if matches:
            return f"–ü–æ—Ö–æ–∂–µ –Ω–∞: **{', '.join(matches)}**\n–£—Ç–æ—á–Ω–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–º–µ–ª –≤ –≤–∏–¥—É?"

    # –ó–∞–ø–∞—Å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
    if any(word in text_lower for word in ["–º–∞–≥–∞–∑–∏–Ω", "–º–∞–≥–∞–∑–∏–Ω—ã", "–≥–¥–µ –∫—É–ø–∏—Ç—å"]):
        return "–£ –º–µ–Ω—è –µ—Å—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ –º–∞–≥–∞–∑–∏–Ω–∞–º: Magnum, Small, Starbucks, –Ø–Ω–¥–µ–∫—Å Go –∏ –¥—Ä—É–≥–∏–µ. –ù–∞–∑–æ–≤–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π ‚Äî –ø–æ–∫–∞–∂—É, —Å —á–µ–º –æ–Ω —Å–≤—è–∑–∞–Ω."

    if any(word in text_lower for word in ["–∫–∞—Ç–µ–≥–æ—Ä–∏—è", "–∫–∞—Ç–µ–≥–æ—Ä–∏–∏", "—Ç–∏–ø —Ç—Ä–∞—Ç"]):
        return "–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –±–∞–∑–µ: –ü—Ä–æ–¥—É–∫—Ç—ã, –ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ê–ª–∫–æ–≥–æ–ª—å, –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è. –ù–∞–∑–æ–≤–∏ –æ–¥–Ω—É ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É."

    # –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–¥–æ—à–ª–æ
    return "–ù–µ –ø–æ–Ω—è–ª –∑–∞–ø—Ä–æ—Å üòÖ –ü–æ–ø—Ä–æ–±—É–π –Ω–∞–∑–≤–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ —Ç–æ–≤–∞—Ä ‚Äî –ø–æ–∏—â—É –≤ –≥—Ä–∞—Ñ–µ –∑–Ω–∞–Ω–∏–π."